<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard — Neon Kenya</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Manrope:wght@400;600;800&family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="src/css/styles.css" />
  <link rel="stylesheet" href="src/css/components.css" />
  <link rel="stylesheet" href="src/css/animations.css" />
  <style>
    .admin-container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { padding: 20px; border-radius: 12px; text-align: center; }
    .stat-number { font-size: 2rem; font-weight: 800; margin: 10px 0; }
    .contacts-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    .contacts-table th, .contacts-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    .contacts-table th { background: var(--surface); font-weight: 600; }
    .service-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 500; }
    .service-design { background: var(--neon); color: var(--bg-start); }
    .service-runway { background: var(--secondary); color: var(--bg-start); }
    .service-editorial { background: var(--accent); color: var(--bg-start); }
    .service-social { background: rgba(255,255,255,0.2); color: var(--text); }
    .loading { text-align: center; padding: 40px; color: var(--muted); }
    .error { text-align: center; padding: 40px; color: #ff4444; }
    .refresh-btn { margin-bottom: 20px; }
    .contact-details { font-size: 0.9rem; color: var(--muted); }
    .timestamp { font-size: 0.8rem; color: var(--muted); }
  </style>
</head>
<body>
  <canvas id="particles" class="particles"></canvas>
  
  <header class="navbar glass" role="banner">
    <div class="nav-left">
      <a href="/" class="brand">
        <img src="/images/logo.svg" alt="Designer logo" class="logo" />
        <span class="brand-name">NEON KENYA ADMIN</span>
      </a>
    </div>
    <div class="nav-right">
      <a href="/" class="btn btn-secondary"><i class="ri-home-5-line"></i> Back to Site</a>
    </div>
  </header>

  <main class="admin-container">
    <section class="section">
      <h1 class="section-title">Admin Dashboard</h1>
      
      <button id="refresh-btn" class="btn btn-primary refresh-btn">
        <i class="ri-refresh-line"></i> Refresh Data
      </button>

      <div class="stats-grid">
        <div class="stat-card glass">
          <h3>Total Contacts</h3>
          <div class="stat-number" id="total-contacts">-</div>
          <p>All time submissions</p>
        </div>
        <div class="stat-card glass">
          <h3>This Month</h3>
          <div class="stat-number" id="month-contacts">-</div>
          <p>New inquiries</p>
        </div>
        <div class="stat-card glass">
          <h3>Popular Service</h3>
          <div class="stat-number" id="popular-service">-</div>
          <p>Most requested</p>
        </div>
      </div>

      <div class="glass" style="padding: 20px; border-radius: 16px;">
        <h2>Recent Contact Submissions</h2>
        <div id="contacts-loading" class="loading">
          <i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>
          Loading contacts...
        </div>
        <div id="contacts-error" class="error" style="display: none;"></div>
        <div id="contacts-container" style="display: none;">
          <table class="contacts-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Service</th>
                <th>Message</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="contacts-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer glass" role="contentinfo">
    <p>© <span id="year"></span> Neon Kenya — Admin Dashboard</p>
  </footer>

  <script type="module" src="src/js/main.js"></script>
  <script>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    // Admin Dashboard JavaScript
    class AdminDashboard {
      constructor() {
        this.contacts = [];
        this.init();
      }

      async init() {
        document.getElementById('refresh-btn').addEventListener('click', () => this.loadContacts());
        await this.loadContacts();
      }

      async loadContacts() {
        const loading = document.getElementById('contacts-loading');
        const error = document.getElementById('contacts-error');
        const container = document.getElementById('contacts-container');

        // Show loading state
        loading.style.display = 'block';
        error.style.display = 'none';
        container.style.display = 'none';

        try {
          const response = await fetch('/api/contacts');
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          
          this.contacts = await response.json();
          this.renderContacts();
          this.updateStats();

          // Show content
          loading.style.display = 'none';
          container.style.display = 'block';
          
        } catch (err) {
          console.error('Failed to load contacts:', err);
          
          // Show error state
          loading.style.display = 'none';
          error.style.display = 'block';
          error.innerHTML = `<i class="ri-error-warning-line"></i> Failed to load contacts: ${err.message}`;
        }
      }

      renderContacts() {
        const tbody = document.getElementById('contacts-tbody');
        tbody.innerHTML = '';

        if (this.contacts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--muted);">No contacts found</td></tr>';
          return;
        }

        this.contacts.forEach(contact => {
          const row = document.createElement('tr');
          const date = new Date(contact.created_at).toLocaleDateString('en-KE', {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit'
          });

          const serviceClass = this.getServiceClass(contact.service);
          const truncatedMessage = contact.message.length > 100 
            ? contact.message.substring(0, 100) + '...' 
            : contact.message;

          row.innerHTML = `
            <td>
              <strong>${this.escapeHtml(contact.name)}</strong>
              <div class="contact-details">ID: ${contact.id}</div>
            </td>
            <td>${this.escapeHtml(contact.email)}</td>
            <td><span class="service-badge ${serviceClass}">${this.escapeHtml(contact.service)}</span></td>
            <td>${this.escapeHtml(truncatedMessage)}</td>
            <td class="timestamp">${date}</td>
          `;
          tbody.appendChild(row);
        });
      }

      updateStats() {
        // Total contacts
        document.getElementById('total-contacts').textContent = this.contacts.length;

        // This month contacts
        const now = new Date();
        const thisMonth = this.contacts.filter(contact => {
          const contactDate = new Date(contact.created_at);
          return contactDate.getMonth() === now.getMonth() && 
                 contactDate.getFullYear() === now.getFullYear();
        });
        document.getElementById('month-contacts').textContent = thisMonth.length;

        // Most popular service
        const services = {};
        this.contacts.forEach(contact => {
          services[contact.service] = (services[contact.service] || 0) + 1;
        });
        
        const popular = Object.entries(services).sort((a, b) => b[1] - a[1])[0];
        document.getElementById('popular-service').textContent = popular ? popular[0] : 'N/A';
      }

      getServiceClass(service) {
        const classes = {
          'Design Consult': 'service-design',
          'Runway Modeling': 'service-runway',
          'Editorial Modeling': 'service-editorial',
          'Social Collaboration': 'service-social'
        };
        return classes[service] || 'service-social';
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // Initialize dashboard when DOM is loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new AdminDashboard());
    } else {
      new AdminDashboard();
    }
  </script>
</body>
</html>